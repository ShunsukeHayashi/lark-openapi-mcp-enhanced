# Lark Base ボタンフィールドオートメーション完全ガイド

## 📋 目次
1. [概要](#概要)
2. [ボタンフィールドとは](#ボタンフィールドとは)
3. [事前準備](#事前準備)
4. [ボタンフィールドの作成](#ボタンフィールドの作成)
5. [オートメーションの設定](#オートメーションの設定)
6. [実装例](#実装例)
7. [トラブルシューティング](#トラブルシューティング)
8. [ベストプラクティス](#ベストプラクティス)

---

## 概要

Lark Baseのボタンフィールドを使用することで、ユーザーがワンクリックで複雑な処理を実行できるようになります。本ガイドでは、ボタンフィールドとオートメーションを組み合わせて、GASと連携する高度なワークフローを構築する方法を解説します。

### 主な用途
- ✅ ステータスの自動更新
- ✅ 外部システムへのデータ送信
- ✅ レポートの自動生成
- ✅ 承認ワークフローの実行
- ✅ 通知の自動送信

---

## ボタンフィールドとは

ボタンフィールドは、Lark Baseの特殊なフィールドタイプで、クリック可能なボタンをテーブルに追加できます。

### 特徴
- 🔘 各レコードに個別のボタンを配置
- ⚡ クリックでオートメーションをトリガー
- 🎨 カスタマイズ可能な表示テキストと色
- 🔒 権限に基づくアクセス制御

---

## 事前準備

### 1. 必要な権限
- Lark Baseの編集権限
- オートメーションの作成権限
- 外部連携を使用する場合はAPI権限

### 2. 必要な情報
- Base App Token: `U38Xbik32acfCBsEbmmjm0NupRe`
- Table ID: `tblpU0WI9GEk2RrX`
- GAS Web App URL: `https://script.google.com/macros/s/AKfycbwJ8vVJ4muYv3BtriUpj8Y5nH3mgMYsmOPQMgJvyAHdJK8btpxaYO05V_Xn6NKwfIk5lg/exec`

---

## ボタンフィールドの作成

### Step 1: フィールドの追加

1. **Lark Baseを開く**
   ```
   https://f82jyx0mblu.jp.larksuite.com/base/U38Xbik32acfCBsEbmmjm0NupRe?table=tblpU0WI9GEk2RrX
   ```

2. **フィールドを追加**
   - テーブルビューで最右列の「**+**」ボタンをクリック
   - フィールドタイプから「**ボタン**」を選択

3. **ボタンの設定**
   ```
   フィールド名: アクション
   ボタンテキスト: 処理を実行
   ボタンの色: 青（推奨）
   ```

### Step 2: ボタンの詳細設定

![ボタン設定画面]
```
┌─────────────────────────────────┐
│ フィールド設定                    │
├─────────────────────────────────┤
│ フィールド名: [アクション      ] │
│                                 │
│ ボタン設定:                     │
│ ├─ テキスト: [処理を実行     ] │
│ ├─ 色:       [● 青          ] │
│ └─ アイコン: [▶ 再生        ] │
│                                 │
│ 説明:                           │
│ [クリックすると処理が実行され  ]│
│ [ます                         ]│
└─────────────────────────────────┘
```

---

## オートメーションの設定

### Step 1: 新規オートメーションの作成

1. **自動化タブを開く**
   - Baseの上部メニューから「**自動化**」をクリック

2. **新規ワークフローを作成**
   - 「**+ ワークフローを作成**」ボタンをクリック
   - ワークフロー名: `ボタンクリック処理`

### Step 2: トリガーの設定

```yaml
トリガータイプ: ボタンがクリックされたとき
対象フィールド: アクション（作成したボタンフィールド）
```

### Step 3: アクションの設定

#### アクション1: レコードの更新
```yaml
アクションタイプ: レコードを更新
更新対象: トリガーされたレコード
更新内容:
  - ステータス: "処理中"
  - 処理開始時刻: 現在時刻
```

#### アクション2: Webhookの送信
```yaml
アクションタイプ: HTTPリクエストを送信
URL: https://script.google.com/macros/s/AKfycbwJ8vVJ4muYv3BtriUpj8Y5nH3mgMYsmOPQMgJvyAHdJK8btpxaYO05V_Xn6NKwfIk5lg/exec
メソッド: POST
ヘッダー:
  Content-Type: application/json
ボディ:
  {
    "action": "button_clicked",
    "record_id": "{{record_id}}",
    "table_id": "{{table_id}}",
    "app_token": "{{app_token}}",
    "clicked_by": "{{current_user.id}}",
    "clicked_at": "{{current_time}}",
    "record_data": {
      "氏名": "{{氏名}}",
      "メールアドレス": "{{メールアドレス}}",
      "部署": "{{部署}}",
      "問い合わせ種別": "{{問い合わせ種別}}",
      "内容": "{{内容}}",
      "緊急度": "{{緊急度}}"
    }
  }
```

#### アクション3: 通知の送信
```yaml
アクションタイプ: 通知を送信
送信先: レコード作成者
メッセージ: |
  処理が開始されました。
  レコードID: {{record_id}}
  処理内容: {{アクション}}
```

### Step 4: エラーハンドリングの設定

```yaml
エラー時の処理:
  - アクション: レコードを更新
    更新内容:
      - ステータス: "エラー"
      - エラーメッセージ: "{{error_message}}"
  
  - アクション: 通知を送信
    送信先: 管理者
    メッセージ: "処理エラーが発生しました: {{error_message}}"
```

---

## 実装例

### 例1: 承認ワークフロー

```javascript
// GAS側の処理 (doPost関数内)
if (eventData.action === 'button_clicked') {
  const recordId = eventData.record_id;
  const clickedBy = eventData.clicked_by;
  
  // 承認処理
  if (eventData.record_data['緊急度'] === '高') {
    // 上位管理者に承認依頼
    sendApprovalRequest(recordId, clickedBy);
  } else {
    // 自動承認
    approveRecord(recordId);
  }
}
```

### 例2: レポート生成

```javascript
// ボタンクリックでPDFレポートを生成
function generateReport(recordId) {
  const record = getRecordDetailsFromLark(recordId);
  
  // PDFを生成
  const pdf = createPDF(record);
  
  // メールで送信
  sendEmailWithAttachment(
    record['メールアドレス'],
    'レポートが生成されました',
    pdf
  );
  
  // ステータスを更新
  updateRecordStatus(recordId, 'レポート送信済み');
}
```

### 例3: 複数レコードの一括処理

```yaml
# ビューでフィルタリングされたレコードに対して一括処理
トリガー: ボタンがクリックされたとき
条件: ビュー内の全レコード
アクション:
  - タイプ: 繰り返し処理
    対象: フィルタされたレコード
    処理:
      - HTTPリクエストを送信
      - レコードを更新
```

---

## トラブルシューティング

### よくある問題と解決方法

#### 1. ボタンがクリックできない
**原因**: 権限不足
**解決方法**: 
- ユーザーの権限を確認
- ボタンフィールドの権限設定を確認

#### 2. オートメーションが実行されない
**原因**: トリガー設定の誤り
**解決方法**:
- トリガーフィールドが正しく設定されているか確認
- オートメーションが有効になっているか確認

#### 3. Webhookが失敗する
**原因**: URL設定やネットワークの問題
**解決方法**:
- WebhookのURLが正しいか確認
- GAS側のdoPost関数が正しく実装されているか確認
- CORS設定を確認

### デバッグ方法

1. **オートメーションログの確認**
   ```
   自動化 > 実行履歴 > 詳細を表示
   ```

2. **GASログの確認**
   ```bash
   clasp logs --watch
   ```

3. **テストモードの使用**
   - オートメーション編集画面で「テスト実行」を使用

---

## ベストプラクティス

### 1. ボタンの命名規則
```
✅ 良い例: 承認する、レポート生成、ステータス更新
❌ 悪い例: ボタン1、クリック、実行
```

### 2. 処理の冪等性
- 同じボタンを複数回クリックしても安全な設計にする
- 処理IDを使用して重複実行を防ぐ

### 3. エラーハンドリング
```javascript
try {
  // メイン処理
  await processRecord(recordId);
  updateStatus(recordId, 'SUCCESS');
} catch (error) {
  updateStatus(recordId, 'ERROR', error.message);
  notifyAdmin(error);
}
```

### 4. パフォーマンス最適化
- 重い処理は非同期で実行
- バッチ処理を活用
- 適切なタイムアウト設定

### 5. セキュリティ
- ボタンアクションの権限チェック
- センシティブなデータの暗号化
- APIキーの安全な管理

---

## 高度な活用例

### 1. 条件付きボタン表示
```javascript
// フォーミュラフィールドと組み合わせて条件付き表示
IF(緊急度 = "高", "🚨 緊急処理", "通常処理")
```

### 2. 複数ボタンの連携
```yaml
ボタン1: データ検証
  ↓ 成功時
ボタン2: 承認申請
  ↓ 承認時
ボタン3: 最終処理
```

### 3. 外部サービス連携
- Slack通知
- Teams連携
- メール送信
- PDF生成
- データエクスポート

---

## まとめ

Lark Baseのボタンフィールドとオートメーションを組み合わせることで、複雑なビジネスプロセスを簡単に自動化できます。本ガイドの手順に従って実装することで、効率的なワークフローを構築できます。

### 次のステップ
1. 簡単なボタンから始める
2. 段階的に複雑な処理を追加
3. ユーザーフィードバックを収集
4. 継続的な改善

### 参考リンク
- [Lark Base公式ドキュメント](https://open.larksuite.com/document)
- [Google Apps Script リファレンス](https://developers.google.com/apps-script)
- [MCP Tools Documentation](https://github.com/larksuite/lark-mcp)