# 🚀 Lark Form to GAS Web View - デプロイ手順

## 📝 前提条件
- Googleアカウント
- Larkアプリの作成済み（App ID/Secret取得済み）
- 先ほど作成したLark Base（顧客問い合わせ管理）

## 🔧 セットアップ手順

### 1. Google Apps Scriptプロジェクトの作成

1. [Google Apps Script](https://script.google.com/)にアクセス
2. 「新規プロジェクト」をクリック
3. プロジェクト名を「Lark Form Integration」に変更

### 2. ファイルの追加

#### 2.1 メインコード（コード.gs）
- デフォルトの「コード.gs」に`Code.gs`の内容をコピー

#### 2.2 スプレッドシートログ機能
1. 「ファイル」→「新規」→「スクリプト」
2. ファイル名を「SpreadsheetLogger」に変更
3. `SpreadsheetLogger.gs`の内容をコピー

#### 2.3 スプレッドシートUI機能
1. 「ファイル」→「新規」→「スクリプト」
2. ファイル名を「SpreadsheetUI」に変更
3. `SpreadsheetUI.gs`の内容をコピー

#### 2.4 HTMLファイル
以下のHTMLファイルを追加：

1. **index.html**（メインビュー）
   - 「ファイル」→「新規」→「HTML」
   - ファイル名を「index」に変更
   - `index.html`の内容をコピー

2. **success-view.html**（成功画面）
   - 「ファイル」→「新規」→「HTML」
   - ファイル名を「success-view」に変更
   - `success-view.html`の内容をコピー

3. **log-viewer.html**（ログビューアー）
   - 「ファイル」→「新規」→「HTML」
   - ファイル名を「log-viewer」に変更
   - `log-viewer.html`の内容をコピー

### 3. スクリプトプロパティの設定

1. プロジェクトの設定（歯車アイコン）をクリック
2. 「スクリプトプロパティ」セクションで「プロパティを追加」

| プロパティ名 | 値 |
|------------|---|
| LARK_APP_ID | cli_a8d2fdb1f1f8d02d |
| LARK_APP_SECRET | V7mzILXEgIaqLwLXtyZstekRJsjRsFfJ |
| LARK_BASE_APP_TOKEN | U38Xbik32acfCBsEbmmjm0NupRe |
| LARK_BASE_TABLE_ID | tblGI9VZmGATO97c |

### 4. デプロイ設定

1. エディタ右上の「デプロイ」→「新しいデプロイ」
2. 設定：
   - **種類**: ウェブアプリ
   - **説明**: Lark Form Handler v1.0
   - **次のユーザーとして実行**: 自分
   - **アクセスできるユーザー**: 全員
3. 「デプロイ」をクリック
4. **Web アプリの URL をコピー**（重要！）

例: `https://script.google.com/macros/s/AKfycby.../exec`

### 5. Lark自動化の設定

1. [Lark Base](https://f82jyx0mblu.jp.larksuite.com/base/U38Xbik32acfCBsEbmmjm0NupRe?table=tblGI9VZmGATO97c)を開く
2. 「自動化」タブをクリック
3. 「新しいワークフロー」を作成

#### トリガー設定：
- **トリガータイプ**: レコードが作成されたとき
- **対象テーブル**: 顧客問い合わせ管理（主キー付き）

#### アクション設定：
- **アクションタイプ**: HTTPリクエストを送信
- **URL**: （GASのWeb アプリURL）
- **メソッド**: POST
- **ヘッダー**: 
  ```
  Content-Type: application/json
  ```
- **ボディ**:
  ```json
  {
    "record_id": "{{record_id}}",
    "event": {
      "type": "record.created",
      "record": {
        "record_id": "{{record_id}}"
      }
    }
  }
  ```

4. ワークフローを有効化

## 🧪 テスト方法

### 1. 設定確認
1. GASエディタで「testConfiguration」関数を選択
2. 実行ボタンをクリック
3. コンソールでエラーがないことを確認

### 2. フォーム送信テスト
1. [お問い合わせフォーム](https://f82jyx0mblu.jp.larksuite.com/base/U38Xbik32acfCBsEbmmjm0NupRe?table=tblGI9VZmGATO97c&view=vewJeXMwzE)を開く
2. テストデータを入力：
   - 氏名: テスト太郎
   - メールアドレス: test@example.com
   - 部署: 開発部
   - 問い合わせ種別: 技術的な質問
   - 内容: これはテストです
   - 緊急度: 中
3. 送信

### 3. 動作確認
1. GASの「実行数」で実行履歴を確認
2. スプレッドシートのログを確認
3. Web ViewのURLにアクセスして表示確認

## 📊 ログの確認

### スプレッドシートログ
- GASが自動的にスプレッドシートを作成
- 「Lark Form GAS Integration Logs」という名前で保存
- フォーム送信ログとエラーログの2つのシート

### ログビューアー
- GAS Web App URL + `?view=logs`
- 例: `https://script.google.com/macros/s/AKfycby.../exec?view=logs`

## 🎨 カスタマイズ

### デザイン変更
`index.html`と`success-view.html`のCSSを編集：
- 色の変更: `background: linear-gradient(...)`
- フォント: `font-family`
- アニメーション: `@keyframes`

### フィールド追加
`index.html`の`fieldLabels`オブジェクトに追加：
```javascript
const fieldLabels = {
    '新フィールド名': '表示ラベル',
    // ...
};
```

## 🔧 トラブルシューティング

### よくあるエラー

1. **「スクリプトプロパティが設定されていません」**
   - プロジェクト設定でプロパティを確認

2. **「アクセス権限がありません」**
   - Larkアプリの権限を確認
   - GASのデプロイ設定を確認

3. **「レコードが見つかりません」**
   - Table IDが正しいか確認
   - Lark自動化のボディ設定を確認

### デバッグ方法
1. GASエディタの「実行数」→「実行履歴」
2. 各実行のログを確認
3. エラーがある場合は詳細を確認

## 🎉 完成！

これで、Larkフォームの送信内容を美しいWeb Viewで確認できるシステムが完成しました。

### システムの流れ：
1. ユーザーがフォームを送信
2. Lark自動化がGASを呼び出し
3. GASがデータを取得・記録
4. 美しいWeb Viewで内容を表示
5. （オプション）送信者にメッセージ送信

Happy coding! 🚀
