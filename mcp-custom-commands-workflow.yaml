# MCP Custom Commands Workflow Definition
# ECé‹å–¶ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒãƒ³ãƒ‰ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®šç¾©

version: "1.0"
metadata:
  description: "EC Operation MCP Tool Workflow Definitions"
  author: "EC Operations Team"
  created: "2025-01-18"
  base_app_token: "W66tbCpb7avIjSsGvBhjRxtZpHc"

# å…±é€šè¨­å®š
defaults:
  error_handling: "continue_with_notification"
  timeout: 300 # seconds
  retry_count: 3

# ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒãƒ³ãƒ‰å®šç¾©
commands:
  # ========================================
  # 1. æ—¥æ¬¡åœ¨åº«ãƒã‚§ãƒƒã‚¯ã‚³ãƒãƒ³ãƒ‰
  # ========================================
  daily_inventory_check:
    description: "æ—¥æ¬¡åœ¨åº«ç¢ºèªã¨ç™ºæ³¨ææ¡ˆ"
    trigger: "manual | schedule:daily:09:00"
    inputs:
      - name: "threshold_days"
        type: "integer"
        default: 30
        description: "åœ¨åº«æ—¥æ•°é–¾å€¤"
    
    workflow:
      - step: "fetch_all_products"
        tool: "bitable_v1_appTableRecord_search"
        params:
          path:
            app_token: "{{base_app_token}}"
            table_id: "tblPSgtK8IBbw9pP"
          data:
            automatic_fields: false
          params:
            page_size: 200
        output: "products_data"
      
      - step: "analyze_inventory"
        tool: "custom_processor"
        processor: "inventory_analyzer"
        inputs:
          products: "{{products_data}}"
          threshold: "{{inputs.threshold_days}}"
        outputs:
          critical: "critical_items"
          warning: "warning_items"
          excess: "excess_items"
      
      - step: "generate_report"
        tool: "custom_formatter"
        template: "inventory_daily_report"
        inputs:
          critical: "{{critical_items}}"
          warning: "{{warning_items}}"
          excess: "{{excess_items}}"
          date: "{{current_date}}"
        output: "report_content"
      
      - step: "send_notification"
        tool: "im_v1_message_create"
        condition: "{{critical_items.length > 0}}"
        params:
          data:
            receive_id_type: "chat_id"
            receive_id: "{{env.ALERT_CHAT_ID}}"
            msg_type: "interactive"
            content: "{{report_content}}"

  # ========================================
  # 2. è‡ªå‹•ç™ºæ³¨ä½œæˆã‚³ãƒãƒ³ãƒ‰
  # ========================================
  auto_create_purchase_order:
    description: "åœ¨åº«ãƒ¬ãƒ™ãƒ«ã«åŸºã¥ãè‡ªå‹•ç™ºæ³¨ä½œæˆ"
    trigger: "manual | api | schedule:daily:10:00"
    inputs:
      - name: "product_id"
        type: "string"
        required: false
        description: "ç‰¹å®šå•†å“IDï¼ˆçœç•¥æ™‚ã¯å…¨å•†å“ãƒã‚§ãƒƒã‚¯ï¼‰"
      - name: "auto_approve"
        type: "boolean"
        default: false
        description: "è‡ªå‹•æ‰¿èªãƒ•ãƒ©ã‚°"
    
    workflow:
      - step: "check_inventory_level"
        tool: "bitable_v1_appTableRecord_search"
        params:
          path:
            app_token: "{{base_app_token}}"
            table_id: "tblPSgtK8IBbw9pP"
          data:
            filter:
              conjunction: "and"
              conditions:
                - field_name: "ğŸ“Šç¾åœ¨åº«"
                  operator: "isLess"
                  value: ["30"]
            sort:
              - field_name: "ğŸ“Šç¾åœ¨åº«"
                desc: false
        output: "low_stock_items"
      
      - step: "calculate_order_quantities"
        tool: "custom_processor"
        processor: "order_calculator"
        inputs:
          items: "{{low_stock_items}}"
          rules:
            category_a_months: 3
            category_b_months: 2
            category_c_months: 1
        output: "order_proposals"
      
      - step: "check_existing_orders"
        tool: "bitable_v1_appTableRecord_search"
        params:
          path:
            app_token: "{{base_app_token}}"
            table_id: "tblTrydqClnBV8Db"
          data:
            filter:
              conjunction: "and"
              conditions:
                - field_name: "ğŸ“ˆç™ºæ³¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹"
                  operator: "isNot"
                  value: ["å…¥åº«å®Œäº†", "ã‚­ãƒ£ãƒ³ã‚»ãƒ«"]
        output: "pending_orders"
      
      - step: "filter_new_orders"
        tool: "custom_processor"
        processor: "order_filter"
        inputs:
          proposals: "{{order_proposals}}"
          existing: "{{pending_orders}}"
        output: "new_orders"
      
      - step: "create_purchase_orders"
        tool: "bitable_v1_appTableRecord_create"
        foreach: "{{new_orders}}"
        params:
          path:
            app_token: "{{base_app_token}}"
            table_id: "tblTrydqClnBV8Db"
          data:
            fields:
              ğŸ“‹ç™ºæ³¨ç•ªå·: "PO-{{generate_po_number()}}"
              ğŸ“ˆç™ºæ³¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: "ç™ºæ³¨æº–å‚™"
              ğŸ“…ç™ºæ³¨æ—¥: "{{current_timestamp}}"
              ğŸ“¦å•†å“ãƒ»éƒ¨å“:
                link_record_ids: ["{{item.record_id}}"]
              ğŸ“Šç™ºæ³¨æ•°é‡: "{{item.order_quantity}}"
              ğŸ’°ç™ºæ³¨å˜ä¾¡: "{{item.unit_cost}}"
              ğŸ’³é€šè²¨ç¨®åˆ¥: "JPY (æ—¥æœ¬å††)"
              ğŸ“…ç´æœŸäºˆå®š: "{{add_days(current_date, 9)}}"
              ğŸ’³æ”¯æ‰•æ¡ä»¶: "æœˆæœ«ç· ã‚"
              ğŸ‘¤ç™ºæ³¨è€…: "Auto PO System"
              ğŸ“å‚™è€ƒ: "è‡ªå‹•ç™ºæ³¨: {{item.reason}}"
        output: "created_orders"
      
      - step: "approval_workflow"
        condition: "{{!inputs.auto_approve}}"
        tool: "custom_workflow"
        workflow: "purchase_approval"
        inputs:
          orders: "{{created_orders}}"
          approval_rules:
            - amount: 500000
              approver: "auto"
            - amount: 2000000
              approver: "department_manager"
            - amount: null
              approver: "executive"

  # ========================================
  # 3. åœ¨åº«ç§»å‹•ãƒ»èª¿æ•´ã‚³ãƒãƒ³ãƒ‰
  # ========================================
  inventory_adjustment:
    description: "åœ¨åº«æ•°é‡ã®èª¿æ•´ã¨ç§»å‹•è¨˜éŒ²"
    trigger: "manual | api"
    inputs:
      - name: "product_id"
        type: "string"
        required: true
      - name: "adjustment_type"
        type: "enum"
        values: ["increase", "decrease", "transfer"]
        required: true
      - name: "quantity"
        type: "integer"
        required: true
      - name: "reason"
        type: "string"
        required: true
    
    workflow:
      - step: "get_current_stock"
        tool: "bitable_v1_appTableRecord_search"
        params:
          path:
            app_token: "{{base_app_token}}"
            table_id: "tblPSgtK8IBbw9pP"
          data:
            filter:
              conjunction: "and"
              conditions:
                - field_name: "record_id"
                  operator: "is"
                  value: ["{{inputs.product_id}}"]
        output: "current_product"
        error_handler:
          type: "fail"
          message: "Product not found"
      
      - step: "validate_adjustment"
        tool: "custom_validator"
        validator: "inventory_adjustment"
        inputs:
          current_stock: "{{current_product.fields.ğŸ“Šç¾åœ¨åº«}}"
          adjustment_type: "{{inputs.adjustment_type}}"
          quantity: "{{inputs.quantity}}"
        output: "validation_result"
      
      - step: "calculate_new_stock"
        tool: "custom_calculator"
        formula: |
          switch(inputs.adjustment_type) {
            case "increase":
              return current_stock + quantity;
            case "decrease":
              return current_stock - quantity;
            case "transfer":
              return current_stock - quantity;
          }
        inputs:
          current_stock: "{{current_product.fields.ğŸ“Šç¾åœ¨åº«}}"
          quantity: "{{inputs.quantity}}"
          adjustment_type: "{{inputs.adjustment_type}}"
        output: "new_stock_level"
      
      - step: "update_stock"
        tool: "bitable_v1_appTableRecord_update"
        params:
          path:
            app_token: "{{base_app_token}}"
            table_id: "tblPSgtK8IBbw9pP"
            record_id: "{{inputs.product_id}}"
          data:
            fields:
              ğŸ“Šç¾åœ¨åº«: "{{new_stock_level}}"
      
      - step: "create_adjustment_log"
        tool: "bitable_v1_appTableRecord_create"
        params:
          path:
            app_token: "{{base_app_token}}"
            table_id: "tblGcwmvAk2HGTRw"  # åœ¨åº«ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«
          data:
            fields:
              èª¿æ•´æ—¥æ™‚: "{{current_timestamp}}"
              å•†å“: 
                link_record_ids: ["{{inputs.product_id}}"]
              èª¿æ•´ã‚¿ã‚¤ãƒ—: "{{inputs.adjustment_type}}"
              èª¿æ•´æ•°é‡: "{{inputs.quantity}}"
              èª¿æ•´å‰åœ¨åº«: "{{current_product.fields.ğŸ“Šç¾åœ¨åº«}}"
              èª¿æ•´å¾Œåœ¨åº«: "{{new_stock_level}}"
              ç†ç”±: "{{inputs.reason}}"
              å®Ÿè¡Œè€…: "{{current_user}}"

  # ========================================
  # 4. å£²ä¸Šåˆ†æãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  # ========================================
  sales_analysis_report:
    description: "æŒ‡å®šæœŸé–“ã®å£²ä¸Šåˆ†æãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ"
    trigger: "manual | schedule:weekly:monday:09:00"
    inputs:
      - name: "period"
        type: "enum"
        values: ["daily", "weekly", "monthly"]
        default: "weekly"
      - name: "target_date"
        type: "date"
        default: "{{current_date}}"
    
    workflow:
      - step: "calculate_date_range"
        tool: "custom_processor"
        processor: "date_calculator"
        inputs:
          period: "{{inputs.period}}"
          target_date: "{{inputs.target_date}}"
        outputs:
          start_date: "period_start"
          end_date: "period_end"
      
      - step: "fetch_sales_data"
        tool: "bitable_v1_appTableRecord_search"
        params:
          path:
            app_token: "{{base_app_token}}"
            table_id: "tblPSgtK8IBbw9pP"
          data:
            field_names:
              - "ğŸ“å•†å“å"
              - "ğŸ“Šç¾åœ¨åº«"
              - "ğŸ“ˆ30æ—¥è²©å£²æ•°"
              - "ğŸ’°å˜ä¾¡"
              - "ğŸ’¸åŸä¾¡"
            automatic_fields: true
        output: "all_products"
      
      - step: "analyze_performance"
        tool: "custom_analyzer"
        analyzer: "sales_performance"
        inputs:
          products: "{{all_products}}"
          period: "{{inputs.period}}"
        outputs:
          top_sellers: "best_products"
          slow_movers: "slow_products"
          revenue_summary: "revenue_data"
          profit_summary: "profit_data"
      
      - step: "generate_charts"
        tool: "custom_visualizer"
        charts:
          - type: "bar"
            data: "{{best_products}}"
            title: "Top 10 Best Sellers"
          - type: "pie"
            data: "{{revenue_data}}"
            title: "Revenue by Category"
          - type: "line"
            data: "{{profit_data}}"
            title: "Daily Profit Trend"
        output: "chart_urls"
      
      - step: "compile_report"
        tool: "custom_report_builder"
        template: "sales_analysis_template"
        inputs:
          period: "{{inputs.period}}"
          date_range: "{{period_start}} - {{period_end}}"
          best_sellers: "{{best_products}}"
          slow_movers: "{{slow_products}}"
          total_revenue: "{{revenue_data.total}}"
          total_profit: "{{profit_data.total}}"
          charts: "{{chart_urls}}"
        output: "report_document"
      
      - step: "save_report"
        tool: "drive_v1_file_create"
        params:
          data:
            name: "Sales_Report_{{inputs.period}}_{{period_end}}"
            type: "docx"
            folder_token: "{{env.REPORTS_FOLDER}}"
            content: "{{report_document}}"

  # ========================================
  # 5. ç·Šæ€¥åœ¨åº«åˆ‡ã‚Œå¯¾å¿œ
  # ========================================
  emergency_stockout_response:
    description: "åœ¨åº«åˆ‡ã‚Œç·Šæ€¥å¯¾å¿œãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼"
    trigger: "manual | alert | api"
    priority: "high"
    inputs:
      - name: "product_id"
        type: "string"
        required: true
      - name: "affected_orders"
        type: "array"
        required: true
    
    workflow:
      - step: "assess_impact"
        tool: "custom_analyzer"
        analyzer: "stockout_impact"
        inputs:
          product_id: "{{inputs.product_id}}"
          orders: "{{inputs.affected_orders}}"
        outputs:
          customer_count: "affected_customers"
          revenue_impact: "lost_revenue"
          alternatives: "substitute_products"
      
      - step: "notify_stakeholders"
        tool: "im_v1_message_create"
        parallel: true
        targets:
          - chat_id: "{{env.MANAGEMENT_CHAT}}"
            template: "stockout_alert_management"
          - chat_id: "{{env.SALES_CHAT}}"
            template: "stockout_alert_sales"
          - chat_id: "{{env.CS_CHAT}}"
            template: "stockout_alert_customer_service"
      
      - step: "create_emergency_po"
        tool: "workflow"
        workflow: "auto_create_purchase_order"
        params:
          product_id: "{{inputs.product_id}}"
          auto_approve: true
          priority: "urgent"
          note: "ç·Šæ€¥åœ¨åº«åˆ‡ã‚Œå¯¾å¿œ"
      
      - step: "customer_notification"
        tool: "custom_batch_processor"
        processor: "customer_notifier"
        inputs:
          customers: "{{affected_customers}}"
          product: "{{inputs.product_id}}"
          alternatives: "{{substitute_products}}"
          template: "stockout_customer_notification"
      
      - step: "create_incident_report"
        tool: "bitable_v1_appTableRecord_create"
        params:
          path:
            app_token: "{{base_app_token}}"
            table_id: "tbl_incident_log"
          data:
            fields:
              incident_type: "stockout"
              product: "{{inputs.product_id}}"
              impact: "{{affected_customers}} customers, Â¥{{lost_revenue}}"
              actions_taken: "{{workflow_log}}"
              timestamp: "{{current_timestamp}}"

# ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å®šç¾©
error_handlers:
  default:
    retry_count: 3
    retry_delay: 5
    notification_channel: "{{env.ERROR_NOTIFICATION_CHAT}}"
    
  critical:
    retry_count: 1
    escalation: "immediate"
    notification_channels:
      - "{{env.ERROR_NOTIFICATION_CHAT}}"
      - "{{env.MANAGEMENT_CHAT}}"

# ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®šç¾©
schedules:
  daily_operations:
    - command: "daily_inventory_check"
      time: "09:00"
      timezone: "Asia/Tokyo"
    
    - command: "auto_create_purchase_order"
      time: "10:00"
      timezone: "Asia/Tokyo"
      conditions:
        - day_of_week: ["mon", "wed", "fri"]
  
  weekly_reports:
    - command: "sales_analysis_report"
      time: "09:00"
      day: "monday"
      timezone: "Asia/Tokyo"
      params:
        period: "weekly"

# æ¨©é™è¨­å®š
permissions:
  daily_inventory_check:
    - role: "inventory_staff"
    - role: "manager"
    - role: "admin"
  
  auto_create_purchase_order:
    - role: "purchasing_staff"
    - role: "manager"
    - role: "admin"
  
  inventory_adjustment:
    - role: "warehouse_staff"
    - role: "manager"
    - role: "admin"
  
  emergency_stockout_response:
    - role: "all_staff"