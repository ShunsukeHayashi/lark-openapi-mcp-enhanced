/**
 * AI-Enhanced Coordinator Usage Example
 * Demonstrates how to use Gemini-powered multi-agent coordination
 */

import { createAIEnhancedCoordinator } from '../ai-enhanced-coordinator';
import { 
  createBaseSpecialist,
  createMessagingSpecialist,
  createDocumentSpecialist,
  createCalendarSpecialist
} from '../specialists';
import { globalRegistry, globalTaskCoordinator } from '../';

// Example usage with the provided API key
export async function demonstrateAICoordination() {
  console.log('ðŸš€ Initializing AI-Enhanced Multi-Agent System...');

  try {
    // 1. Initialize specialist agents
    console.log('ðŸ“‹ Registering specialist agents...');
    const baseAgentId = await createBaseSpecialist();
    const messagingAgentId = await createMessagingSpecialist();
    const documentAgentId = await createDocumentSpecialist();
    const calendarAgentId = await createCalendarSpecialist();

    // 2. Create AI-Enhanced Coordinator with Gemini API key
    const coordinator = await createAIEnhancedCoordinator(
      'AIzaSyA4lKChvPh6DnvqQUslqL1mlpaABas2J18'
    );

    console.log('âœ… Multi-agent system initialized with AI capabilities');

    // 3. Example 1: Complex Business Workflow
    console.log('\nðŸŽ¯ Example 1: Customer Onboarding Workflow');
    const onboardingResult = await coordinator.enhancedTaskDecomposition(
      'æ–°ã—ã„é¡§å®¢ã®ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ—ãƒ­ã‚»ã‚¹ã‚’å®Ÿè¡Œï¼šé¡§å®¢æƒ…å ±ã‚’Baseã«ç™»éŒ²ã—ã€ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ã€åˆå›žãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã—ã€ãƒãƒ¼ãƒ ã«é€šçŸ¥ã™ã‚‹',
      {
        priority: 'high',
        deadline: '24æ™‚é–“ä»¥å†…',
        customerType: 'enterprise'
      },
      {
        customerName: 'æ ªå¼ä¼šç¤¾ã‚µãƒ³ãƒ—ãƒ«',
        industry: 'technology',
        teamLead: 'tanaka@company.com'
      }
    );

    console.log('ðŸ§  AI Analysis Result:');
    console.log(`  Complexity: ${onboardingResult.complexity}`);
    console.log(`  Subtasks generated: ${onboardingResult.subtasks.length}`);
    console.log(`  AI Confidence: ${onboardingResult.aiAnalysis?.agentRecommendation?.confidence || 'N/A'}`);
    console.log('  Recommendations:');
    onboardingResult.recommendations.forEach(rec => console.log(`    - ${rec}`));

    // 4. Example 2: Agent Assignment Optimization
    console.log('\nâš¡ Example 2: Optimized Agent Assignment');
    const assignmentResult = await coordinator.optimizeAgentAssignment(
      onboardingResult.subtasks,
      {
        maxConcurrentTasks: 3,
        preferParallelExecution: true,
        prioritizeQuality: true
      }
    );

    console.log('ðŸŽ¯ Assignment Optimization:');
    console.log(`  Efficiency score: ${Math.round(assignmentResult.efficiency * 100)}%`);
    console.log(`  Assignments: ${Object.keys(assignmentResult.assignments).length} tasks assigned`);
    console.log('  Optimization insights:');
    assignmentResult.recommendations.forEach(rec => console.log(`    - ${rec}`));

    // 5. Example 3: Real-time Monitoring Simulation
    console.log('\nðŸ“Š Example 3: AI-Powered Monitoring');
    
    // Simulate some task results
    const simulatedResults = [
      {
        taskId: 'task_1',
        taskName: 'Customer Data Registration',
        success: true,
        data: { customerId: 'CUST_001', recordsCreated: 1 },
        duration: 45,
        context: { quality: 'high' }
      },
      {
        taskId: 'task_2',
        taskName: 'Welcome Document Creation',
        success: true,
        data: { documentId: 'DOC_001', pageCount: 3 },
        duration: 120,
        context: { quality: 'medium' }
      },
      {
        taskId: 'task_3',
        taskName: 'Meeting Schedule',
        success: false,
        data: null,
        duration: 0,
        context: { error: 'Calendar conflict detected' }
      }
    ];

    const monitoringResult = await coordinator.enhancedWorkflowMonitoring(
      'workflow_001',
      simulatedResults
    );

    console.log('ðŸ“ˆ Monitoring Insights:');
    monitoringResult.insights.forEach(insight => console.log(`  - ${insight}`));
    console.log('ðŸ”® Predictions:');
    console.log(`  Likely outcome: ${monitoringResult.predictions?.likelyOutcome || 'unknown'}`);
    console.log(`  Quality forecast: ${Math.round((monitoringResult.predictions?.qualityForecast || 0) * 100)}%`);

    // 6. Example 4: Intelligent Error Recovery
    console.log('\nðŸ”§ Example 4: AI-Powered Error Recovery');
    const errorRecovery = await coordinator.intelligentErrorRecovery(
      'workflow_001',
      {
        type: 'calendar_conflict',
        severity: 'medium',
        affectedTasks: ['task_3'],
        message: 'Requested meeting time conflicts with existing appointment'
      },
      [simulatedResults[2]]
    );

    console.log('ðŸ› ï¸ Recovery Strategy:');
    console.log(`  Strategy: ${errorRecovery.strategy}`);
    console.log('  Actions:');
    errorRecovery.actions.forEach(action => console.log(`    - ${action}`));
    console.log('  Prevention measures:');
    errorRecovery.preventionMeasures.forEach(measure => console.log(`    - ${measure}`));

    // 7. Example 5: Intelligent Summary Generation
    console.log('\nðŸ“ Example 5: AI-Generated Summary');
    const executiveSummary = await coordinator.generateIntelligentSummary(
      'workflow_001',
      simulatedResults,
      'executive'
    );

    console.log('ðŸ“‹ Executive Summary:');
    console.log(executiveSummary);

    // 8. System Statistics
    console.log('\nðŸ“Š System Statistics:');
    const registryStats = globalRegistry.getStatistics();
    console.log(`  Total agents: ${registryStats.totalAgents}`);
    console.log(`  Active agents: ${registryStats.activeAgents}`);
    console.log(`  Agent types: ${Object.keys(registryStats.byType).join(', ')}`);

    console.log('\nðŸŽ‰ AI-Enhanced Multi-Agent System demonstration completed!');
    return true;

  } catch (error) {
    console.error('âŒ Demonstration failed:', error);
    return false;
  }
}

/**
 * Example: Advanced Workflow with Real Lark Operations
 */
export async function advancedWorkflowExample() {
  console.log('ðŸ¢ Advanced Workflow Example: Monthly Report Generation');

  try {
    const coordinator = await createAIEnhancedCoordinator(
      'AIzaSyA4lKChvPh6DnvqQUslqL1mlpaABas2J18'
    );

    // Complex multi-domain task
    const reportTask = await coordinator.enhancedTaskDecomposition(
      'æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆï¼šå–¶æ¥­ãƒ‡ãƒ¼ã‚¿ã‚’Baseã‹ã‚‰æŠ½å‡ºã—ã€åˆ†æžãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ã€ãƒãƒ¼ãƒ ä¼šè­°ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã—ã€ãƒ¬ãƒãƒ¼ãƒˆã‚’é–¢ä¿‚è€…ã«é…å¸ƒã™ã‚‹',
      {
        reportType: 'monthly_sales',
        departments: ['sales', 'marketing', 'management'],
        deadline: 'æœˆæœ«ã¾ã§',
        format: 'executive_summary'
      },
      {
        baseAppId: 'app_sales_tracking',
        tableIds: ['sales_data', 'customer_info', 'pipeline'],
        recipients: ['ceo@company.com', 'sales-team@company.com'],
        meetingDuration: 60
      }
    );

    console.log('ðŸ“Š Monthly Report Workflow Analysis:');
    console.log(`  AI-generated subtasks: ${reportTask.subtasks.length}`);
    console.log(`  Complexity assessment: ${reportTask.complexity}`);
    console.log(`  AI confidence: ${Math.round((reportTask.aiAnalysis?.agentRecommendation?.confidence || 0) * 100)}%`);

    // Show the AI-optimized task breakdown
    reportTask.subtasks.forEach((subtask, index) => {
      console.log(`  ${index + 1}. ${subtask.name}`);
      console.log(`     Capabilities: ${subtask.requiredCapabilities.join(', ')}`);
      console.log(`     Type: ${subtask.type}, Priority: ${subtask.priority}`);
      if (subtask.dependencies) {
        console.log(`     Dependencies: ${subtask.dependencies.length} task(s)`);
      }
    });

    // AI-optimized agent assignment
    const optimization = await coordinator.optimizeAgentAssignment(
      reportTask.subtasks,
      {
        preferQualityOverSpeed: true,
        enableParallelExecution: true,
        maxConcurrentTasks: 2
      }
    );

    console.log('\nâš¡ AI-Optimized Assignment:');
    console.log(`  Assignment efficiency: ${Math.round(optimization.efficiency * 100)}%`);
    console.log('  Optimization recommendations:');
    optimization.recommendations.forEach(rec => console.log(`    - ${rec}`));

    return {
      success: true,
      subtasks: reportTask.subtasks,
      assignments: optimization.assignments,
      aiAnalysis: reportTask.aiAnalysis
    };

  } catch (error) {
    console.error('âŒ Advanced workflow failed:', error);
    return { success: false, error: String(error) };
  }
}

/**
 * Example: Integration with existing Lark MCP tools
 */
export async function larkIntegrationExample() {
  console.log('ðŸ”— Lark MCP Integration Example');

  try {
    const coordinator = await createAIEnhancedCoordinator(
      'AIzaSyA4lKChvPh6DnvqQUslqL1mlpaABas2J18'
    );

    // Task that requires real Lark API calls
    const integrationTask = await coordinator.enhancedTaskDecomposition(
      'æ–°ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚­ãƒƒã‚¯ã‚ªãƒ•ï¼šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã€ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ ã—ã€ã‚­ãƒƒã‚¯ã‚ªãƒ•ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¨­å®šã—ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–‹å§‹é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹',
      {
        projectName: 'AI Enhanced MCP Project',
        teamSize: 5,
        duration: '3ãƒ¶æœˆ',
        budget: 'Â¥5,000,000'
      },
      {
        teamMembers: [
          'developer1@company.com',
          'designer1@company.com', 
          'pm1@company.com'
        ],
        stakeholders: [
          'manager@company.com',
          'ceo@company.com'
        ]
      }
    );

    console.log('ðŸš€ Project Kickoff Workflow:');
    console.log(`  Generated ${integrationTask.subtasks.length} AI-optimized subtasks`);
    
    // Show how AI mapped to specific Lark capabilities
    integrationTask.subtasks.forEach((task, i) => {
      console.log(`\n  Task ${i + 1}: ${task.name}`);
      console.log(`    Required capabilities: ${task.requiredCapabilities.join(', ')}`);
      console.log(`    AI reasoning: ${task.context.aiReasoning || 'Standard workflow step'}`);
      console.log(`    Estimated duration: ${task.estimatedDuration}s`);
    });

    return {
      success: true,
      workflow: integrationTask,
      message: 'Integration workflow generated successfully'
    };

  } catch (error) {
    console.error('âŒ Integration example failed:', error);
    return { success: false, error: String(error) };
  }
}

// Export for easy testing
export {
  demonstrateAICoordination as main,
  advancedWorkflowExample,
  larkIntegrationExample
};

// Auto-run if called directly
if (require.main === module) {
  demonstrateAICoordination()
    .then(success => {
      if (success) {
        console.log('\nâœ… All examples completed successfully!');
        process.exit(0);
      } else {
        console.log('\nâŒ Some examples failed');
        process.exit(1);
      }
    })
    .catch(error => {
      console.error('Fatal error:', error);
      process.exit(1);
    });
}